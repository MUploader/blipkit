#!/usr/local/bin/swipl -q -t main -s

:- use_module(bioprolog(bioprolog_util)).

user:file_search_path(obo, OBO) :-
	(getenv('OBO_HOME', OBO_HOME)
	->  true
        ;   getenv('HOME',HOME),
            concat_atom([HOME,'/','cvs/obo'],OBO_HOME)),
        concat_atom([OBO_HOME,'/','ontology'],OBO).
user:file_search_path(go, GO) :-
	(getenv('GO_HOME', GO_HOME)
	->  true
        ;   getenv('HOME',HOME),
            concat_atom([HOME,'/','cvs/go'],GO_HOME)),
        concat_atom([GO_HOME,'/','ontology'],GO).

resource(go,go('gene_ontology.pro')).
%resource(pato,obo('phenotype/attribute_and_value.pro')).
resource(pato,'/users/cjm/obol/data/ont_attribute_and_value.P').
resource(fly_anatomy,obo('anatomy/gross_anatomy/animal_gross_anatomy/fly/fly_anatomy.pro')).
resource(zebrafish_anatomy,obo('anatomy/gross_anatomy/animal_gross_anatomy/zebrafish/zebrafish_anatomy.pro')).
resource(fly_instances,'/users/cjm/Data/phenotype/fb_inst.pro').

expand_resource(R,Px):-
        resource(R,P),
        expand_file_search_path(P,Px).

main:-
        getopt([],FileL),
        findall(F,expand_resource(_,F),OntL),
        load_factfiles(OntL),
        load_factfiles(FileL),
        findall(_,(allele(ID,N),wq(allele(ID,N))),_),        
        findall(_,(allele_gene(ID,N),wq(allele_gene(ID,N))),_),        
        findall(_,(gene_organism(ID,N),wq(gene_organism(ID,N))),_),        
        findall(_,(organism(ID,N,GS),wq(organism(ID,N,GS))),_),        
        findall(_,(phen_names(IDph,A,Ns,Ne,Na,Nv),
                   ent(Ns,Ne,IDe),
                   q(Na,IDa,attribute),
                   q(Nv,IDv,value),
                   wq(phenotype(IDph,A,IDe,IDa,IDv))),_),
        halt.

wq(X):-
        writeq(X),writeln('.').

ent(_Ns,Ne,IDe):-
        class(IDe,Ne).
ent(Ns,Ne,IDe):-
        concat_atom([Ns,',',Ne],Nconcat),
        class(IDe,Nfull),
        sub_atom(Nfull,St,_Len,Offset,Nconcat),
        St=4,
        Offset=0.
        
q(N,ID,Ont):-
        downcase_atom(N,Nlc),
        belongs(ID,Ont),
        class(ID,N2),
        downcase_atom(N2,Nlc).
        
