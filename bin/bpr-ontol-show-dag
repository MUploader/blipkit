#!/usr/local/bin/swipl -q -g main -t halt -s

:- use_module(bioprolog(ontol)).
:- use_module(bioprolog(bioprolog_util)).
:- use_module(bioprolog(io)).
:- use_module(library(lists)).

main:-
        getopt([atom([id],ID),
                atom([name,n],N),
                atom([format,from,f],Format),
                bool(synonyms,WithSynonyms),
                atoms([res,r],ResL),
                atoms([i,input],InputFileL),
                atom([reltype,t],Type,all)],
               FileL),
        findall(File,(member(File,InputFileL),
                      load_biofile(Format,File)),_),
        load_bioresources(ResL),
        load_factfiles(FileL),
        (class(ID,N) -> true ; die(no_such_class(ID,N))),
        writeln(class(ID,N)),
        %setof(P,dag(ID,P),_),
        (WithSynonyms=0 -> true ; true),
        showdag(ID,Type,[with_synonyms:WithSynonyms]),
        halt.

writetab(N):-
        (N =< 0
        ->  true
        ;   write(' '),
            N2 is N-1,
            writetab(N2)).

rcode(root,'$'):-!.
rcode(subclass,'I'):-!.
rcode(part_of,'P'):-!.
rcode(develops_from,'D'):-!.
rcode(X,X).

shownode(T,ID,Opts):-
        class(ID,N),
        rcode(T,C),
        write(C/ID/N),
        (member(with_synonyms:1,Opts)
        ->  forall(synonym(ID,_SynType,Syn),
                   format(' synonym: ~w',Syn))
        ;   true),
        nl.
showdag(ID,Type,Opts):-
        setof(IDp,parentRT(ID,IDp),IDpL),
        setof(IDp,(member(IDp,IDpL),noparent(IDp),showdag(root/IDp,Type,[],IDpL,Opts)),_).
showdag(T/ID,Type,P,L,Opts):-
        length(P,I),
        writetab(I),
        shownode(T,ID,Opts),
        findall(IDc/Tc,(parent(IDc,Tc,ID),oktype(Tc,Type),member(IDc,L),showdag(Tc/IDc,Type,[T|P],L,Opts)),_).

oktype(_,all):- !.
oktype(X,X).

dag(ID,P2):-
        class(ID,N),
        showparent(ID,T,P),
        P2=[T/ID|P],
        length(P,I),
        writetab(I),
        writeln(T/ID/N).
showparent(ID,T,P):-
        parent(ID,T,IDp),
        dag(IDp,P).
showparent(ID,root,[]):-
        not(parent(ID,_,_)).

