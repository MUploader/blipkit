#!/usr/local/bin/swipl -q -g main -t halt -s

/*

  input: prolog factfile containing instance (inst/2)

  instances to defined classes are expanded (generates inst_sv/3,
  basic instance is mapped to genus)
  
*/

:- use_module(bio(ontol)).
:- use_module(bio(bioprolog_util)).

usage('bpr-ontol-expand-xps -r dl_go fly_ga.pro > fly_ga_xp.pro').
      

main:-
        getopt([atom([r,resource],Res)],FileL),
        (var(Res) -> true ; load_resource(Res)),
        setof(File,(member(File,FileL),expand_xps_in_file(File)),_),
        halt.

expand_xps_in_file(File):-
        open(File,read,IO),
        expand_xps(IO),
        close(IO).
expand_xps(IO):-
        repeat,
        read(IO,Term),
        (Term=end_of_file
        ->  true,
            !
        ;   replace_inst_pred(Term,Terms),
            write_terms(Terms),
            fail).
expand_xps.

replace_inst_pred(inst(ID,ClassID),[inst(ID,GenusID)|PL]):-
        genus(ClassID,GenusID),
        setof(inst_sv(ID,Type,ToID),differentium(ClassID,Type,ToID),PL),
        !.
replace_inst_pred(X,[X]).

write_terms([]).
write_terms([H|L]):-
        write_term(H),
        write_terms(L).
write_term(H):-
        writeq(H),write('.'),nl.
